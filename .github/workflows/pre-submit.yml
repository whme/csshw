#
#   csshw Pre-Submit CI
#
# Runs CI workflows based on changed files in pull requests.
# Uses paths-filter to determine which jobs need to run.

name: Pre-Submit CI

on:
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    runs-on: &runner ubuntu-latest
    outputs:
      src: ${{ steps.changes.outputs.src }}
      workflows: ${{ steps.changes.outputs.workflows }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - '.cargo/**'
              - 'src/**'
              - 'build.rs'
              - 'Cargo.toml'
              - 'clippy.toml'
              - 'Makefile.toml'
              - 'rustfmt.toml'
            workflows:
              - '.github/workflows/pre-submit.yml'
              - '.github/workflows/post-submit.yml'
              - '.github/workflows/_shared-ci.yml'

  ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.src == 'true' || needs.detect-changes.outputs.workflows == 'true'
    uses: ./.github/workflows/_shared-ci.yml

  coverage-report:
    needs: ci
    if: always() && needs.ci.result == 'success'
    runs-on: *runner
    steps:
      - uses: actions/checkout@v5

      - name: Download Coverage XML Data
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml-data
          path: coverage-data/

      - name: Generate Code Coverage Summary
        uses: insightsengineering/coverage-action@v3
        with:
          # Path to the Cobertura XML report.
          path: coverage-data/coverage.xml
          # Minimum total coverage, if you want to the
          # workflow to enforce it as a standard.
          # This has no effect if the `fail` arg is set to `false`.
          threshold: 80
          # Fail the workflow if the minimum code coverage
          # requirements are not satisfied.
          fail: false
          # Publish the rendered output as a PR comment
          publish: true
          # Create a coverage diff report.
          diff: true
          # Branch to diff against.
          # Compare the current coverage to the coverage
          # determined on this branch.
          diff-branch: main
          # This is where the coverage reports for the
          # `diff-branch` are stored.
          # Branch is created if it doesn't already exist'.
          diff-storage: _xml_coverage_reports
          # A custom title that can be added to the code
          # coverage summary in the PR comment.
          coverage-summary-title: "Code Coverage Summary"
          # Failure modes for coverage regression detection:
          # Fail if any changed file has more uncovered lines (pycobertura exit code 2)
          uncovered-statements-increase-failure: false
          # Fail if new uncovered statements are introduced despite overall improvement (pycobertura exit code 3)
          new-uncovered-statements-failure: false
          # Fail if the overall coverage percentage decreases (more forgiving approach)
          coverage-rate-reduction-failure: false

  diff-cover:
    needs: ci
    if: always() && needs.ci.result == 'success'
    runs-on: *runner
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Read diff-cover version
        id: diffcover
        run: |
          echo "version=$(cat diff-cover.version)" >> $GITHUB_OUTPUT

      - name: Cache pip packages
        uses: actions/cache@v4
        id: pip-cache
        with:
          path: ~/.cache/pip
          key: |
            pip-diff-cover-${{ runner.os }}-v1-${{ steps.diffcover.outputs.version }}
          restore-keys: |
            pip-diff-cover-${{ runner.os }}-v1-

      - name: Install diff-cover
        run: pip install diff-cover==${{ steps.diffcover.outputs.version }}

      - name: Download Coverage XML Data
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml-data
          path: coverage-data/

      - name: Run diff-cover
        id: diff-cover
        run: |
          if diff-cover coverage-data/coverage.xml --fail-under=80 --format markdown:diff-cover.md; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Prepare comment content
        if: always()
        run: |
          mkdir -p comment
          echo "${{ github.event.number }}" > comment/pr_number.txt
          echo "diff-cover" > comment/header.txt

          # Write the header
          echo "ðŸ¤– **Diff Coverage Check**" > comment/body.txt
          echo "" >> comment/body.txt

          # Add status
          if [[ "${{ steps.diff-cover.outputs.result }}" == "success" ]]; then
            echo "âœ… **Success!**" >> comment/body.txt
          else
            echo "âŒ **Failed!**" >> comment/body.txt
          fi

          echo "" >> comment/body.txt

          # Add the diff-cover report
          cat diff-cover.md >> comment/body.txt

      - name: Upload comment artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comment
          path: comment/

      - if: steps.diff-cover.outputs.result == 'failed'
        run: exit 1

  ci-summary:
    needs: [detect-changes, ci, coverage-report, diff-cover]
    if: always()
    runs-on: *runner
    steps:
      - run: |
          needs_json='${{ toJSON(needs) }}'
          failed=0
          echo "Job results:"
          for job in $(jq -r 'keys[]' <<< "$needs_json"); do
            result=$(jq -r --arg job "$job" '.[$job].result' <<< "$needs_json")
            echo "- $job: $result"
            if [[ ! "$result" =~ ^(success|skipped)$ ]]; then
              failed=1
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "âŒ One or more jobs failed or were cancelled!"
            exit 1
          else
            echo "âœ… All jobs succeeded or were skipped."
          fi
